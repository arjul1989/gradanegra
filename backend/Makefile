# üõ†Ô∏è Makefile para Grada Negra API
# Simplifica comandos comunes de desarrollo y deployment

.PHONY: help install dev deploy deploy-prod verify test clean logs shell

# Variables del proyecto
PROJECT_ID := gradanegra-api-350907539319
SERVICE_NAME := gradanegra-api
REGION := us-central1
BACKEND_DIR := .
NODE_ENV := development

# Colores para output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m

# Ayuda - Mostrar comandos disponibles
help:
	@echo "$(BLUE)üöÄ Grada Negra API - Comandos Disponibles$(NC)"
	@echo "======================================"
	@echo ""
	@echo "$(GREEN)Desarrollo:$(NC)"
	@echo "  install    - Instalar dependencias"
	@echo "  dev        - Ejecutar en modo desarrollo"
	@echo "  test       - Ejecutar tests"
	@echo ""
	@echo "$(GREEN)Deployment:$(NC)"
	@echo "  deploy     - Deployment local robusto"
	@echo "  deploy-prod - Deployment autom√°tico con Cloud Build"
	@echo "  verify     - Verificar deployment"
	@echo ""
	@echo "$(GREEN)Monitoreo:$(NC)"
	@echo "  logs       - Ver logs del servicio"
	@echo "  shell      - Abrir shell en container"
	@echo "  status     - Ver estado del servicio"
	@echo ""
	@echo "$(GREEN)Mantenimiento:$(NC)"
	@echo "  clean      - Limpiar dependencias y archivos temporales"
	@echo "  secrets    - Verificar secretos"
	@echo ""

# Instalaci√≥n de dependencias
install:
	@echo "$(BLUE)üì¶ Instalando dependencias...$(NC)"
	npm ci
	@echo "$(GREEN)‚úÖ Dependencias instaladas$(NC)"

# Modo desarrollo
dev:
	@echo "$(BLUE)üõ†Ô∏è Iniciando en modo desarrollo...$(NC)"
	@export NODE_ENV=development && npm start

# Deployment local robusto
deploy:
	@echo "$(BLUE)üöÄ Iniciando deployment robusto...$(NC)"
	chmod +x deploy-robust.sh
	./deploy-verify.sh
	@echo "$(GREEN)‚úÖ Deployment completado$(NC)"

# Deployment autom√°tico a producci√≥n
deploy-prod:
	@echo "$(BLUE)üåê Iniciando deployment autom√°tico...$(NC)"
	@if [ ! -f ".gcloudignore" ]; then echo "$(RED)‚ùå No se encontr√≥ .gcloudignore$(NC)"; exit 1; fi
	@echo "$(YELLOW)‚ö†Ô∏è  Esto iniciar√° un build autom√°tico con Cloud Build$(NC)"
	@read -p "¬øContinuar? (y/n) " confirm && [ "$$confirm" = "y" ]
	gcloud builds submit --config cloudbuild.yaml .
	@echo "$(GREEN)‚úÖ Deployment autom√°tico completado$(NC)"

# Verificaci√≥n post-deployment
verify:
	@echo "$(BLUE)üîç Verificando deployment...$(NC)"
	chmod +x verify-deployment.sh
	./verify-deployment.sh

# Tests
test:
	@echo "$(BLUE)üß™ Ejecutando tests...$(NC)"
	npm test
	@echo "$(GREEN)‚úÖ Tests completados$(NC)"

# Ver logs
logs:
	@echo "$(BLUE)üìã Mostrando logs...$(NC)"
	gcloud run services logs read $(SERVICE_NAME) --project=$(PROJECT_ID) --region=$(REGION) --limit=50

# Estado del servicio
status:
	@echo "$(BLUE)üìä Estado del servicio:$(NC)"
	gcloud run services describe $(SERVICE_NAME) --project=$(PROJECT_ID) --region=$(REGION) --format="export"

# Limpiar archivos temporales
clean:
	@echo "$(BLUE)üßπ Limpiando archivos temporales...$(NC)"
	rm -rf node_modules/
	rm -f *.log
	rm -rf logs/
	rm -rf tmp/
	@echo "$(GREEN)‚úÖ Archivos limpiados$(NC)"

# Verificar secretos
secrets:
	@echo "$(BLUE)üîê Verificando secretos...$(NC)"
	gcloud secrets versions list --project=$(PROJECT_ID)

# Abrir shell en container (solo local)
shell:
	@echo "$(BLUE)üê≥ Abriendo shell en container...$(NC)"
	docker run -it --rm -v $$(pwd):/app -w /app node:20-alpine /bin/bash

# Health check r√°pido
health:
	@echo "$(BLUE)‚ù§Ô∏è  Verificando health check...$(NC)"
	@curl -f -s https://$(SERVICE_NAME)-$(PROJECT_ID).$(REGION).run.app/health || echo "$(RED)‚ùå Servicio no disponible$(NC)"

# Informaci√≥n del proyecto
info:
	@echo "$(BLUE)üìã Informaci√≥n del Proyecto:$(NC)"
	@echo "  Proyecto ID: $(PROJECT_ID)"
	@echo "  Servicio: $(SERVICE_NAME)"
	@echo "  Regi√≥n: $(REGION)"
	@echo "  Ambiente: $(NODE_ENV)"
	@echo ""
	@echo "$(BLUE)üåê URLs:$(NC)"
	@echo "  Backend: https://$(SERVICE_NAME)-$(PROJECT_ID).$(REGION).run.app"
	@echo "  Frontend: https://gradanegra-frontend-$(PROJECT_ID).$(REGION).run.app"

# Setup inicial
setup:
	@echo "$(BLUE)‚öôÔ∏è  Setup inicial del proyecto...$(NC)"
	@echo "$(YELLOW)Verificando herramientas...$(NC)"
	@command -v node >/dev/null 2>&1 || { echo "$(RED)‚ùå Node.js no est√° instalado$(NC)"; exit 1; }
	@command -v npm >/dev/null 2>&1 || { echo "$(RED)‚ùå npm no est√° instalado$(NC)"; exit 1; }
	@command -v gcloud >/dev/null 2>&1 || { echo "$(RED)‚ùå gcloud CLI no est√° instalado$(NC)"; exit 1; }
	@echo "$(GREEN)‚úÖ Herramientas verificadas$(NC)"
	@echo "$(YELLOW)Configurando gcloud...$(NC)"
	@read -p "Email de gcloud: " email && gcloud config set account $$email
	@echo "$(GREEN)‚úÖ Setup completado$(NC)"